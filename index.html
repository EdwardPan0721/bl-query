<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>小提單查詢與下載</title>
</head>
<body>
  <h2>小提單查詢系統</h2>

  <label>提單號碼：<input type="text" id="blNo"></label><br>
  <label>貨櫃號碼：<input type="text" id="containerNo"></label><br>
  <label>船名：<input type="text" id="vesselName"></label><br>
  <label>航次：<input type="text" id="voyage"></label><br><br>

  <button onclick="queryBL()">查詢</button>
  <button onclick="downloadBL()">下載 PDF</button>

  <hr>
  <div id="result" style="display: none;">
    <h3>=====查詢結果=====</h3>
    <p>提單號碼：<span id="bl">－</span></p>
    <p>電放狀態：<span id="status">－</span></p>
    <p>含稅總計：<span id="sumFee">－</span></p>
    <p>場內免租到期日：<span id="fulldate">－</span></p>
    <p>場外免租日：<span id="emptyDays">0</span>個日曆天(領櫃隔日為第1日)</p>
    <p>預計發單時間：<span id="issuedate">－</span></p>
  </div>

  <script>
    const baseUrl = "https://script.google.com/macros/s/AKfycbzajr-3e-vSTnoOPnkLUw_-7pS-UEQXt6nSNsRTM3OSaMYwBbtXCCqLOB4jy_VDlMax/exec";

    async function queryBL() {
      const bl = document.getElementById("blNo").value.trim();
      const container = document.getElementById("containerNo").value.trim();

      if (!bl || !container) {
        alert("請輸入提單號碼與貨櫃號碼");
        return;
      }

      const queryUrl = `${baseUrl}?blNumber=${encodeURIComponent(bl)}&containerNo=${encodeURIComponent(container)}`;

      try {
        const response = await fetch(queryUrl);
        const result = await response.json();

        if (result.error) {
          alert(result.error);
          return;
        }

        document.getElementById("result").style.display = "block";
        document.getElementById("bl").textContent = result.提單號碼 || "－";
        document.getElementById("status").textContent = result.電放狀態 || "－";
        document.getElementById("sumFee").textContent = result.含稅總計 >= 0 ? `$${Number(result.含稅總計).toLocaleString()}` : "－";
        document.getElementById("fulldate").textContent = result.場內到期日 || "－";
        document.getElementById("emptyDays").textContent = Number(result.場外日 || 0) + Number(result.場外額外日 || 0);
        document.getElementById("issuedate").textContent = result.預計發單時間 || "－";
      } catch (error) {
        console.error(error);
        alert("查詢失敗，請稍後再試");
      }
    }

    async function downloadBL() {
      const bl = document.getElementById("blNo").value.trim();
      const container = document.getElementById("containerNo").value.trim();
      const vessel = document.getElementById("vesselName").value.trim();
      const voyage = document.getElementById("voyage").value.trim();

      if (!bl || !container || !vessel || !voyage) {
        alert("請輸入完整資料（提單號碼、貨櫃號碼、船名與航次）");
        return;
      }

      const downloadUrl = `${baseUrl}?blNumber=${encodeURIComponent(bl)}&containerNo=${encodeURIComponent(container)}&vesselName=${encodeURIComponent(vessel)}&voyage=${encodeURIComponent(voyage)}&download=true`;

      try {
        const response = await fetch(downloadUrl);
        const result = await response.json();

        if (result.downloadUrl) {
          window.open(result.downloadUrl, "_blank");
        } else {
          alert("找不到對應的 PDF 小提單");
        }
      } catch (error) {
        console.error(error);
        alert("下載失敗，請稍後再試");
      }
    }
  </script>
</body>
</html>
